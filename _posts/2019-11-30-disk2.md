---
title: 磁盘故障和对策
date: 2019-11-30 02:00:00
categories:
- Linux
tags:
- 磁盘
description: 介绍磁盘故障和对策
---

# 磁盘故障

* 间断性故障： 偶尔的读写失败，遇到时多试几次又好了。
* 介质损坏： 不管重试多少次，某个扇区都读写不了。
* 写故障： 企图写一个扇区时，既不能正确的写，也不能读出先前写入的数据，可能是断电导致的扇区写一半这种。
* 磁盘崩溃： 整个磁盘永久的不可用。

# 解决策略

读一个扇区，首先需要传输一个扇区到磁盘控制器，并且磁盘控制器需要有策略能够判断读到的内容是正确的。如果一次读不成功，就认为发生了一次`间断性故障`，可以配置策略不断尝试读，直到成功或只重试100次。

写一个扇区，磁盘控制器需要有策略确定最终写入的内容是否和控制器缓存中的一致，最直接的方法是，写完后在读一次对应扇区，全面比较一下。但是这种方法比较慢。

* 校验和

每个扇区附加若干校验位，比如8bit，每个bit负责扇区中每个byte的对应bit的奇偶校验。一个校验位和它负责的数据位总是有偶数个1。这不能保证不出错，因为可能有两个位同时写反，这并不会影响校验和。

奇数个bit翻转，校验和感知错误，偶数个bit翻转，校验和感知不到错误，可以认为，如果发生错误，通过1个校验位没有发现这个错误的概率是50%。因此发生大规模错误（假设涉及所有一个校验道），8个校验位，都没感知到错误的概率是 1/256 。因此当用更多byte当作校验和时，错误不被感知的可能性就更小了。

以上，我们假设了两点，一、磁盘出现错误的情况很少。二、出现错误时是大规模，涉及多个校验道（一个校验位负责一个校验道）的。

当每个bit同时属于多个校验道时，错误不被发现的概率就变小了。如果只是8个bit这种，对极小规模的错误（仅涉及1个校验道的2位），不能发现的概率还是挺高的。

* 稳定存储

校验和可以高效的帮助检测介质损坏和读写故障，但是不提供修复能力。写有一种困境：我们写了一块内容，但是不能读出新的内容，这时我们不能确定旧的内容有没有被破坏。

为了解决这个问题，采用的策略是在一块或多块磁盘上将一组扇区做成镜像扇区，可以先操作其中一个扇区，成功或失败后再操作另外一些。

磁盘控制器需要能够当两边数据不一致时，恢复到一致的状态。当一边扇区损坏，用另一边修复，这个很好理解。当两个扇区都是完好的，这时就需要根据先后操作顺序，复制数据，达到一致状态。

镜像扇区的问题是如果一组扇区同时出现问题，数据就会丢失。这种可能性比较小。

* RAID技术

磁盘作为独立硬件，可能突然整体不可用，这时候需要冗余机制，来从其他地方获取这个盘上的数据。

RAID1：镜像磁盘。

RAID4：附加一个独立的奇偶校验盘，每个盘数据变化都会修改奇偶校验盘数据，因此奇偶校验盘最容易坏。 新奇偶校验值 = !(写入值 XOR 旧值) 。有一定故障恢复能力。

RAID5：将奇偶校验盘功能打散成为分布在各个数据盘中的奇偶校验块，这样能够平均写入负载，如果一共M个磁盘，一次写中，作为数据块可能性是1/M，作为冗余块是M-1/M * 1/M-1 = 1/M-1，总共2/M。

RAID6：汉明码纠错，保证多个盘崩溃的数据恢复。

